{{- if .Values.gatekeeper.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: "{{ include "cdp.backend.fullname" . }}-gatekeeper-secrets"
  labels:
    {{- include "cdp.backend.labels" . | nindent 4 }}
type: Opaque
stringData:
  config.yaml: |
    client-id: {{ .Values.gatekeeper.config.clientId }}
    client-secret: {{ .Values.gatekeeper.config.clientSecret }}
    discovery-url: {{ .Values.gatekeeper.config.discoveryUrl }}
    enable-default-deny: true
    enable-json-logging: {{ .Values.gatekeeper.config.enableJsonLogging }}
    enable-metrics: {{ .Values.gatekeeper.config.enableMetrics }}
    enable-refresh-tokens: {{ .Values.gatekeeper.config.enableRefreshTokens }}
    enable-session-cookies: {{ .Values.gatekeeper.config.enableSessionCookies }}
    {{- if .Values.gatekeeper.config.storeUrl }}
    store-url: {{ .Values.gatekeeper.config.storeUrl }}
    {{- end }}
    no-redirects: true
    encryption-key: {{ .Values.gatekeeper.config.encryptionKey }}
    skip-openid-provider-tls-verify: {{ .Values.gatekeeper.config.skipOpenidProviderTlsVerify }}
    skip-access-token-clientid-check: {{ .Values.gatekeeper.config.skipAccessTokenClientIdCheck }}
    listen: :{{ .Values.gatekeeper.config.listen }}
    listen-admin: :{{ .Values.gatekeeper.config.listenAdmin }}
    secure-cookie: {{ .Values.gatekeeper.config.secureCookie }}
    redirection-url: {{ .Values.gatekeeper.config.redirectionUrl }}
    upstream-url: http://127.0.0.1:{{ .Values.backend.configs.listenPort }}
    server-read-timeout: {{ .Values.gatekeeper.config.serverReadTimeout }}
    server-write-timeout: {{ .Values.gatekeeper.config.serverWriteTimeout }}
    server-idle-timeout: {{ .Values.gatekeeper.config.serverIdleTimeout }}
    upstream-response-header-timeout: {{ .Values.gatekeeper.config.upstreamResponseHeaderTimeout }}
    verbose: {{ .Values.gatekeeper.config.verbose }}
    add-claims:
      - given_name
      - family_name
      - session_state
    resources:
      - uri: /graphql
        methods:
        - GET
        white-listed: true
      - uri: /graphql-schema
        methods:
        - GET
        - POST
        white-listed: true
      - uri: /healthcheck
        methods:
        - GET
        white-listed: true
      - uri: /email-settings
        methods:
        - GET
        white-listed: true
      - uri: /enclave/*
        methods:
        - GET
        - POST
        - PATCH
        white-listed: true
      - uri: /metadata-seed/*
        methods:
        - POST
        white-listed: true
      - uri: /pipeline/*
        methods:
        - POST
        white-listed: true
      - uri: /webhooks/*
        methods:
        - POST
        white-listed: true
      - uri: /frontend-dumps*
        methods:
        - GET
        - POST
        white-listed: true
      - uri: /dataset-matching-groups
        methods:
        - GET
        white-listed: true
      - uri: /jobs
        methods:
        - GET
        white-listed: true
{{- end }}

