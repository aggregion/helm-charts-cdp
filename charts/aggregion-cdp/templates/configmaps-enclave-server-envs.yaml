{{- if .Values.enclave.enabled }}
{{- $backendName := include "cdp.backend.fullname" . }}
{{- $enclaveName := include "cdp.enclave.fullname" . }}
{{- $dataserviceName := include "cdp.dataservice.fullname" . }}
{{- $envPrefix := "" -}}
{{- if .Values.enclave.scone.enabled -}}
  {{- $envPrefix = "ENCLAVE_" -}}
{{- end}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $enclaveName }}-config
  labels:
    {{- include "cdp.enclave.labels" . | nindent 4 }}
data:
  {{ $envPrefix }}SERVER_PORT: "{{ .Values.enclave.configs.listenPort }}"
  {{ $envPrefix }}SERVER_INNER_PORT: "{{ .Values.enclave.configs.listenInnerPort }}"
  {{ $envPrefix }}CH_TYPE: "real"
  {{ $envPrefix }}CH_HOST: "{{ .Values.backend.configs.clickhouseHost }}"
  {{ $envPrefix }}CH_PORT: "{{ .Values.backend.configs.clickhousePort }}"
  {{ $envPrefix }}CH_DATABASE_NAME: "{{ .Values.backend.configs.clickhouseDb }}"
  {{ $envPrefix }}SERVICES_HOST: "localhost"
  {{ $envPrefix }}SERVICES_PORT: "8322"
  {{ $envPrefix }}DMP_BASE_URL: "http://{{ $backendName }}:{{ .Values.backend.service.api.port }}/enclave"
  {{ $envPrefix }}DATASERVICE_BASE_URL: "http://{{ $dataserviceName }}:{{ .Values.dataservice.service.port }}"
  {{ $envPrefix }}DATASERVICE_TOKEN: "{{ .Values.enclave.configs.dataserviceToken }}"
  {{ $envPrefix }}DISABLE_PRETTY_LOGS: "{{ .Values.enclave.configs.prettyLogs }}"
  {{ $envPrefix }}WORKER_HEAP_SIZE_MB: "{{ .Values.enclave.configs.workerHeapSizeMb }}"
  {{ $envPrefix }}RABBITMQ_URL: "{{ .Values.backend.configs.rabbitmqUrl }}"
  {{- if .Values.enclave.scone.enabled }}
  CONFIG_FILE: "/config/local.json"
  API_KEY: "{{ .Values.enclave.scone.espApiKey }}"
  ESP_URI: "{{ .Values.enclave.scone.espAddr }}"
  SCONE_HEAP: "{{ .Values.enclave.scone.heapSize }}"
  {{- end }}
{{- end }}
