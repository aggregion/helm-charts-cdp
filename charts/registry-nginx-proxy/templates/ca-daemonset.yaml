{{- if .Values.daemonset.enabled -}}
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "registry-nginx-proxy.fullname" . }}
  labels:
    {{- include "registry-nginx-proxy.labels" . | nindent 4 }}
    app: ca-daemonset
spec:
  selector:
    matchLabels:
      {{- include "registry-nginx-proxy.selectorLabels" . | nindent 6 }}
      app: ca-daemonset
  template:
    metadata:
      labels:
        {{- include "registry-nginx-proxy.selectorLabels" . | nindent 8 }}
        app: ca-daemonset
    spec:
      hostPID: true
      hostNetwork: true
      initContainers:
        - name: init-node
          command: ["nsenter"]
          args: ["--mount=/proc/1/ns/mnt", "--", "sh", "-c", "$(SETUP_SCRIPT)"]
          image: ubuntu
          env:
            - name: TRUSTED_CERT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "registry-nginx-proxy.fullname" . }}-ca
                  key: ca.crt
            - name: SETUP_SCRIPT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "registry-nginx-proxy.fullname" . }}-ca
                  key: setup.sh
          securityContext:
            privileged: true
      containers:
        - name: wait
          image: {{ .Values.daemonset.pauseImage }}
{{- end }}
